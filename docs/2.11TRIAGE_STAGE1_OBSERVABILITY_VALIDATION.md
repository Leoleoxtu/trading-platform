# âœ… Triage Stage 1 - Observability Validation

## Definition of Done - Checklist

### 1. Infrastructure Running

```bash
# Start full stack
cd /home/leox7/trading-platform/infra
docker compose --profile infra --profile apps --profile observability up -d

# Wait for services
sleep 60

# Verify services are running
docker compose ps | grep -E "triage-stage1|prometheus|grafana"
```

**Expected**: All 3 services should be "Up" with healthy status.

---

### 2. Stage 1 Metrics Endpoint

```bash
# Direct test from host
curl -s http://localhost:8006/metrics | grep triage_stage1 | head -20
```

**Expected Output** (sample):
```
# HELP triage_stage1_events_consumed_total Total events consumed
# TYPE triage_stage1_events_consumed_total counter
triage_stage1_events_consumed_total 0.0
# HELP triage_stage1_events_routed_total Events routed by bucket
# TYPE triage_stage1_events_routed_total counter
triage_stage1_events_routed_total{bucket="FAST"} 0.0
triage_stage1_events_routed_total{bucket="STANDARD"} 0.0
triage_stage1_events_routed_total{bucket="COLD"} 0.0
triage_stage1_events_routed_total{bucket="DROP_HARD"} 0.0
# HELP triage_stage1_events_failed_total Events failed by reason
# TYPE triage_stage1_events_failed_total counter
# HELP triage_stage1_dedup_hits_total Deduplication hits
# TYPE triage_stage1_dedup_hits_total counter
triage_stage1_dedup_hits_total 0.0
# HELP triage_stage1_processing_duration_seconds Processing duration histogram
# TYPE triage_stage1_processing_duration_seconds histogram
# HELP triage_stage1_score_distribution Score distribution histogram
# TYPE triage_stage1_score_distribution histogram
# HELP triage_stage1_last_success_timestamp Last successful processing timestamp
# TYPE triage_stage1_last_success_timestamp gauge
```

---

### 3. Prometheus Target UP

Open: http://localhost:9090/targets

**Expected**:
- Job: `triage-stage1`
- Endpoint: `http://triage-stage1:8006/metrics`
- State: **UP** (green)
- Last Scrape: < 10s ago

**Alternative CLI check**:
```bash
curl -s http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | select(.labels.job=="triage-stage1") | {job: .labels.job, health: .health, lastScrape: .lastScrape}'
```

---

### 4. Grafana Dashboard Visible

1. Open: http://localhost:3001
2. Login: `admin` / `admin`
3. Navigate: Dashboards â†’ Browse â†’ "Triage Stage 1"

**Expected**:
- Dashboard title: "Triage Stage 1"
- Tags: `pipeline`, `triage`, `stage1`
- 15 panels visible across 4 rows:
  - ðŸ“Š Throughput & Routing (3 panels)
  - âš¡ Performance & Latency (6 panels)
  - ðŸš¨ Errors & Quality (3 panels)
  - ðŸ“ˆ Score Distribution (2 panels)

---

### 5. Panels Display Data (After Injecting Events)

```bash
# Inject test event to normalized topic
docker exec -it redpanda rpk topic produce events.normalized.v1 <<'EOF'
{"schema_version":"normalized_event.v1","event_id":"test-001","text":"Apple reported Q4 earnings beating estimates with $34.2B revenue","source_type":"rss","source_name":"bloomberg","canonical_url":"https://example.com/test","lang":"en","event_time_utc":"2024-12-31T10:00:00Z","normalized_at_utc":"2024-12-31T10:05:00Z","quality_flags":[],"original_source":{"id":"orig-001"}}
EOF
```

Wait 30 seconds, then check:
- **Panel A**: Ingest rate shows > 0
- **Panel B**: Routed rate shows activity
- **Panel C**: Pie chart shows bucket distribution
- **Panel D**: Latency appears (should be < 100ms)
- **Panel G**: Last success age shows recent value (< 60s)

---

### 6. PromQL Queries Working

Test in Prometheus UI (http://localhost:9090/graph):

**Query 1 - Ingest Rate**:
```promql
rate(triage_stage1_events_consumed_total[5m])
```

**Query 2 - Bucket Distribution**:
```promql
sum by(bucket) (rate(triage_stage1_events_routed_total[5m]))
```

**Query 3 - Latency P95**:
```promql
histogram_quantile(0.95, sum(rate(triage_stage1_processing_duration_seconds_bucket[5m])) by (le))
```

---

## Files Modified/Created

| File | Action | Purpose |
|------|--------|---------|
| `infra/observability/prometheus.yml` | âœ… Already configured | Scrape job `triage-stage1:8006` |
| `infra/observability/grafana/dashboards/triage_stage1.json` | âœ… Created | 15-panel dashboard |
| `infra/observability/grafana/dashboards/triage_health.json` | âŒ Deleted | Replaced by triage_stage1.json |
| `infra/observability/grafana/provisioning/datasources/datasource.yml` | âœ… Already configured | Prometheus datasource |
| `infra/observability/grafana/provisioning/dashboards.yml` | âœ… Already configured | Dashboard provisioning |
| `infra/docker-compose.yml` | âœ… Already configured | triage-stage1 on trading-platform network |
| `docs/90_operations.md` | âœ… Updated | Added Triage Stage 1 monitoring section |

---

## Dashboard Panels Summary

| ID | Panel Name | Type | PromQL Query |
|----|------------|------|--------------|
| 1 | A - Stage1 Ingest Rate | timeseries | `rate(triage_stage1_events_consumed_total[5m])` |
| 2 | B - Routed Rate by Bucket (stacked) | timeseries | `sum by(bucket) (rate(triage_stage1_events_routed_total[5m]))` |
| 3 | C - Bucket Share (%) | piechart | `sum by(bucket) (...) / scalar(sum(...))` |
| 4 | D - Latency p95 & p50 | timeseries | `histogram_quantile(0.95, ...)` |
| 5 | P95 Current | stat | `histogram_quantile(0.95, ...)` |
| 6 | Total Consumed | stat | `triage_stage1_events_consumed_total` |
| 7 | Total Routed | stat | `sum(triage_stage1_events_routed_total)` |
| 8 | G - Last Success Age | stat | `time() - triage_stage1_last_success_timestamp` |
| 9 | Avg Events/sec | stat | `rate(triage_stage1_events_consumed_total[5m])` |
| 10 | Service Status | stat | `time() - triage_stage1_last_success_timestamp` (mapped) |
| 11 | E - Error Rate | timeseries | `sum by(reason) (rate(triage_stage1_events_failed_total[5m]))` |
| 12 | F - Dedup Hits Rate | timeseries | `rate(triage_stage1_dedup_hits_total[5m])` |
| 13 | DROP_HARD Rate (%) | timeseries | `(rate(...{bucket="DROP_HARD"}[5m]) / rate(...[5m])) * 100` |
| 14 | H - Score Distribution | timeseries | `sum(rate(triage_stage1_score_distribution_bucket[5m])) by (le)` |
| 15 | Score Percentiles | timeseries | `histogram_quantile(0.50/0.75/0.90/0.95, ...)` |

---

## Quick Validation Commands

```bash
# One-liner validation
echo "=== Health ===" && curl -s http://localhost:8006/health | jq . && \
echo "=== Metrics ===" && curl -s http://localhost:8006/metrics | grep -c triage_stage1 && echo "metrics found" && \
echo "=== Prometheus ===" && curl -s "http://localhost:9090/api/v1/targets" | jq '.data.activeTargets[] | select(.labels.job=="triage-stage1") | .health'
```

**Expected Output**:
```
=== Health ===
{"status": "healthy", ...}
=== Metrics ===
XX metrics found
=== Prometheus ===
"up"
```

---

## Troubleshooting

### Prometheus shows triage-stage1 as DOWN

```bash
# Check if service is running
docker compose ps triage-stage1

# Check network connectivity (from inside Docker)
docker exec prometheus wget -qO- http://triage-stage1:8006/metrics | head -5

# Check logs
docker compose logs triage-stage1 --tail 50
```

### Grafana shows "No data"

1. Check time range is correct (last 6h default)
2. Verify Prometheus datasource is working: Connections â†’ Data sources â†’ Prometheus â†’ "Save & Test"
3. Check that events have been processed (inject test event)
4. Check PromQL syntax in Explore view

### Dashboard not appearing

```bash
# Check dashboard file exists
ls -la infra/observability/grafana/dashboards/triage_stage1.json

# Check provisioning config
cat infra/observability/grafana/provisioning/dashboards.yml

# Restart Grafana to reload dashboards
docker compose restart grafana
```

---

## âœ… All Validations Complete

When all checks pass:
- [ ] `docker compose ps` shows all services Up
- [ ] `curl localhost:8006/metrics` returns triage_stage1_* metrics
- [ ] Prometheus /targets shows triage-stage1 as UP
- [ ] Grafana dashboard "Triage Stage 1" is visible
- [ ] Panels show data after injecting test events
- [ ] 3 PromQL queries work in Prometheus UI

**Observability for Triage Stage 1 is fully operational! ðŸŽ‰**
