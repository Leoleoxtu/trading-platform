{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Triaged Event Schema v1",
  "description": "Schema for events processed by Triage Stage 2 with NLP enrichment",
  "type": "object",
  "required": [
    "schema_version",
    "event_id",
    "triaged_at_utc",
    "pipeline_version",
    "source_type",
    "source_name",
    "lang",
    "normalized_text",
    "entities",
    "sentiment",
    "triage_score",
    "priority",
    "triage_reasons",
    "thresholds",
    "regime",
    "quality_flags"
  ],
  "additionalProperties": false,
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "triaged_event.v1"
    },
    "event_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique event identifier"
    },
    "triaged_at_utc": {
      "type": "string",
      "format": "date-time",
      "description": "Timestamp when triage Stage 2 completed (ISO 8601 UTC)"
    },
    "pipeline_version": {
      "type": "string",
      "description": "Version of the triage pipeline (e.g., 'triage-stage2.v1.0')"
    },
    "source_type": {
      "type": "string",
      "enum": ["rss", "twitter", "reddit", "news_api", "web_scraper", "market"]
    },
    "source_name": {
      "type": "string",
      "description": "Specific source name (e.g., 'bloomberg', 'reuters')"
    },
    "canonical_url": {
      "type": ["string", "null"],
      "format": "uri",
      "description": "Original URL if available"
    },
    "event_time_utc": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "Original event timestamp"
    },
    "lang": {
      "type": "string",
      "pattern": "^[a-z]{2}$",
      "description": "ISO 639-1 language code (en, fr, etc.)"
    },
    "dedup_key": {
      "type": ["string", "null"],
      "description": "Deduplication key from normalizer"
    },
    "normalized_text": {
      "type": "string",
      "description": "Normalized text used for NLP processing"
    },
    "normalized_text_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA-256 hash of normalized_text"
    },
    "entities": {
      "type": "array",
      "description": "Named entities extracted via spaCy NER",
      "items": {
        "type": "object",
        "required": ["type", "text", "confidence"],
        "additionalProperties": false,
        "properties": {
          "type": {
            "type": "string",
            "enum": ["ORG", "PERSON", "PRODUCT", "GPE", "MONEY", "PERCENT", "DATE", "EVENT"]
          },
          "text": {
            "type": "string",
            "minLength": 1
          },
          "confidence": {
            "type": "number",
            "minimum": 0,
            "maximum": 1
          },
          "start": {
            "type": "integer",
            "minimum": 0
          },
          "end": {
            "type": "integer",
            "minimum": 0
          }
        }
      }
    },
    "money_mentions": {
      "type": "object",
      "required": ["present"],
      "properties": {
        "present": {
          "type": "boolean"
        },
        "amounts": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "value": {
                "type": "number"
              },
              "currency": {
                "type": "string"
              },
              "text": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "percent_mentions": {
      "type": "object",
      "required": ["present"],
      "properties": {
        "present": {
          "type": "boolean"
        },
        "values": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "value": {
                "type": "number"
              },
              "text": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "tickers": {
      "type": "array",
      "description": "Validated stock tickers",
      "items": {
        "type": "object",
        "required": ["symbol", "confidence", "method"],
        "properties": {
          "symbol": {
            "type": "string",
            "pattern": "^[A-Z]{1,5}$"
          },
          "confidence": {
            "type": "number",
            "minimum": 0,
            "maximum": 1
          },
          "method": {
            "type": "string",
            "enum": ["whitelist", "entity_match", "regex", "inherited"]
          }
        }
      }
    },
    "sentiment": {
      "type": "object",
      "required": ["score", "confidence", "model"],
      "additionalProperties": false,
      "properties": {
        "score": {
          "type": "number",
          "minimum": -1,
          "maximum": 1,
          "description": "Sentiment score: -1 (bearish) to +1 (bullish)"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Model confidence in the sentiment prediction"
        },
        "model": {
          "type": "string",
          "const": "finbert",
          "description": "Sentiment model used"
        },
        "label": {
          "type": "string",
          "enum": ["positive", "negative", "neutral"]
        }
      }
    },
    "triage_score": {
      "type": "number",
      "minimum": 0,
      "maximum": 100,
      "description": "Final triage score (0-100)"
    },
    "priority": {
      "type": "string",
      "enum": ["P0", "P1", "P2", "P3"],
      "description": "Priority level: P0 (highest) to P3 (lowest)"
    },
    "triage_reasons": {
      "type": "array",
      "description": "Explainable reasons for the score (closed list)",
      "items": {
        "type": "string",
        "enum": [
          "HIGH_SOURCE_QUALITY",
          "LOW_SOURCE_QUALITY",
          "HAS_VALID_TICKER",
          "NO_TICKER",
          "KEYWORD_EARNINGS",
          "KEYWORD_REGULATION",
          "KEYWORD_MACRO",
          "KEYWORD_SECURITY",
          "KEYWORD_MERGER",
          "KEYWORD_BANKRUPTCY",
          "STRONG_SENTIMENT",
          "WEAK_SENTIMENT",
          "LOW_SENTIMENT_CONF",
          "STRONG_ENTITIES",
          "WEAK_ENTITIES",
          "SHORT_TEXT",
          "LONG_TEXT",
          "NER_EMPTY",
          "HAS_MONEY_MENTION",
          "HAS_PERCENT_MENTION",
          "VERY_RECENT",
          "AGED_EVENT",
          "STRESS_REGIME_BOOST",
          "HIGH_LOAD_PENALTY"
        ]
      }
    },
    "score_breakdown": {
      "type": "object",
      "description": "Detailed score components for auditing",
      "properties": {
        "keywords": {
          "type": "number",
          "minimum": 0,
          "maximum": 30
        },
        "source_quality": {
          "type": "number",
          "minimum": 0,
          "maximum": 25
        },
        "ticker_confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 20
        },
        "entity_strength": {
          "type": "number",
          "minimum": 0,
          "maximum": 10
        },
        "sentiment_impact": {
          "type": "number",
          "minimum": 0,
          "maximum": 15
        }
      }
    },
    "thresholds": {
      "type": "object",
      "required": ["T0", "T1", "T2"],
      "description": "Thresholds used for priority assignment (for audit)",
      "properties": {
        "T0": {
          "type": "number",
          "description": "Threshold for P0 priority"
        },
        "T1": {
          "type": "number",
          "description": "Threshold for P1 priority"
        },
        "T2": {
          "type": "number",
          "description": "Threshold for P2 priority"
        }
      }
    },
    "regime": {
      "type": "object",
      "required": ["market_regime", "load_regime"],
      "description": "Current market and pipeline load regimes",
      "properties": {
        "market_regime": {
          "type": "string",
          "enum": ["CALM", "NORMAL", "STRESS"]
        },
        "load_regime": {
          "type": "string",
          "enum": ["LOW_LOAD", "NORMAL_LOAD", "HIGH_LOAD"]
        },
        "vix_value": {
          "type": ["number", "null"]
        },
        "consumer_lag": {
          "type": ["integer", "null"]
        },
        "p95_latency_ms": {
          "type": ["number", "null"]
        }
      }
    },
    "quality_flags": {
      "type": "array",
      "description": "Quality or processing flags",
      "items": {
        "type": "string",
        "enum": [
          "LOW_TEXT",
          "TEXT_TRUNCATED",
          "LANG_UNKNOWN",
          "NER_EMPTY",
          "FINBERT_LOW_CONF",
          "NO_ENTITIES",
          "TICKER_AMBIGUOUS",
          "INHERITED_FROM_STAGE1"
        ]
      }
    },
    "stage1_score": {
      "type": ["number", "null"],
      "minimum": 0,
      "maximum": 100,
      "description": "Score from Stage 1 if available"
    },
    "stage1_bucket": {
      "type": ["string", "null"],
      "enum": [null, "FAST", "STANDARD", "COLD"]
    },
    "processing_time_ms": {
      "type": "number",
      "description": "Time taken for Stage 2 processing in milliseconds"
    }
  }
}
